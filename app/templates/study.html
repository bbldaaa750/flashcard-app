{% extends 'base.html' %}
{% block content %}
<div class="container mt-4 text-center" style="max-width: 600px;">
    
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h3 class="mb-0">{{ deck.title }}</h3>
            <small class="text-muted">Карточка <span id="counter">1</span> из {{ cards_json|length }}</small>
        </div>

        <a href="{{ url_for('deck.index') }}" class="btn btn-outline-secondary btn-sm" title="Закончить тренировку">
            &times; Выход
        </a>
    </div>

    <div class="scene" style="perspective: 1000px; height: 300px; cursor: pointer;">     
        <div class="card-obj" id="flashcard" style="width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.6s;">
            
            <div class="card-face card-front bg-white border shadow-sm rounded d-flex align-items-center justify-content-center p-4" 
                 style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden;">
                <h2 id="card-front-text">Загрузка...</h2>
                <div class="text-muted small position-absolute bottom-0 mb-3">Нажми, чтобы перевернуть</div>
            </div>

            <div class="card-face card-back bg-light border shadow-sm rounded d-flex align-items-center justify-content-center p-4" 
                 style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg);">
                <h2 id="card-back-text">...</h2>
            </div>
            
        </div>
    </div>

    <div class="mt-4 row justify-content-center">
        <div class="col-6 col-md-4 d-grid">
            <button id="prev-btn" class="btn btn-danger btn-lg">
                &larr; Назад
            </button>
        </div>
    
        <div class="col-6 col-md-4 d-grid">
            <button id="next-btn" class="btn btn-primary btn-lg">
                Далее &rarr;
            </button>
        </div>
    </div>
</div>

<script>
    const cards = JSON.parse('{{ cards_json|tojson }}');
    let currentIndex = 0;
    let isFlipped = false;

    const cardElement = document.getElementById('flashcard');
    const frontText = document.getElementById('card-front-text');
    const backText = document.getElementById('card-back-text');
    const counter = document.getElementById('counter');
    const nextBtn = document.getElementById('next-btn');
    const prevBtn = document.getElementById('prev-btn');

    function renderCard() {
        if (currentIndex >= cards.length) {
            if (isFlipped) {
                cardElement.style.transform = 'rotateY(0deg)';
                isFlipped = false;
            }

            frontText.innerText = "Всё выучено! 🎉";
            backText.innerText = "";
            cardElement.style.pointerEvents = "none";

            nextBtn.disabled = true;
            nextBtn.innerText = "Конец";
            prevBtn.disabled = false;
            
        } else {
            const card = cards[currentIndex];
            frontText.innerText = card.front;
            backText.innerText = card.back;
            counter.innerText = currentIndex + 1;
            
            cardElement.style.pointerEvents = "auto"; 

            nextBtn.disabled = false;
            nextBtn.innerText = "Далее \u2192";
            prevBtn.disabled = (currentIndex === 0);
        }
    }

    renderCard();

    document.querySelector('.scene').addEventListener('click', function() {
        if (currentIndex >= cards.length) return;

        isFlipped = !isFlipped;
        if (isFlipped) {
            cardElement.style.transform = 'rotateY(180deg)';
        } else {
            cardElement.style.transform = 'rotateY(0deg)';
        }
    });

    nextBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentIndex < cards.length) {
            
            if (isFlipped) {
                isFlipped = false;
                cardElement.style.transform = 'rotateY(0deg)';
                
                setTimeout(() => {
                    currentIndex++;
                    renderCard();
                }, 600);
                
            } else {
                currentIndex++;
                renderCard();
            }
        }
    });

    prevBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (currentIndex > 0) {
            if (isFlipped) {
                cardElement.style.transform = 'rotateY(0deg)';
                isFlipped = false;
                
                setTimeout(() => {
                    currentIndex--;
                    renderCard();
                }, 600);
            } else {
                currentIndex--;
                renderCard();
            }
        }
    });

</script>
{% endblock %}
